<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Sentimen Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        /* Custom styles without @apply */
        .dashboard-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #f3f4f6;
        }

        .stats-card {
            padding: 1.5rem;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.1) 0%, transparent 60%);
        }

        .sentiment-badge {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .sentiment-badge.positive {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .sentiment-badge.negative {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .sentiment-badge.neutral {
            background-color: #dbeafe;
            color: #1e40af;
        }

        /* Custom Table Styles */
        .custom-table {
            width: 100%;
        }

        .custom-table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 700px;
            scrollbar-width: thin;
        }

        .custom-table thead {
            background-color: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .custom-table th {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .custom-table td {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
            white-space: nowrap;
            font-size: 0.875rem;
            color: #111827;
            border-bottom: 1px solid #f3f4f6;
        }

        .custom-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .text-cell {
            max-width: 16rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-cell:hover {
            white-space: normal;
            overflow: visible;
            z-index: 20;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        /* Chart Container */
        .chart-container {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #f3f4f6;
            height: 400px;
        }

        /* Custom Button */
        .custom-button {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            background-color: #2563eb;
            color: white;
            border-radius: 0.5rem;
            font-weight: 500;
            transition-property: background-color;
            transition-duration: 200ms;
        }

        .custom-button:hover {
            background-color: #1d4ed8;
        }

        .custom-button:focus {
            outline: none;
            --tw-ring-offset-width: 2px;
            --tw-ring-color: #3b82f6;
            --tw-ring-offset-color: #fff;
            box-shadow: 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color), 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
        }

        /* Custom Form */
        .custom-textarea {
            display: block;
            width: 100%;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .custom-textarea:focus {
            border-color: #3b82f6;
            --tw-ring-color: #3b82f6;
            box-shadow: 0 0 0 1px var(--tw-ring-color);
            outline: none;
        }
    </style>

    {% if plots %}
    <script id="plotly-data" type="application/json">
        {{ plots | safe }}
    </script>
    {% endif %}
</head>
<body class="min-h-screen">
    <div class="p-6">
        <header class="mb-8">
            <h1 class="text-2xl font-bold text-gray-900">Dashboard Analisis Sentimen</h1>
            <p class="text-gray-600">Analisis sentimen menggunakan RoBERTa untuk Bahasa Indonesia</p>
        </header>

        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card text-white">
                <h5 class="text-sm font-medium opacity-80">Total Data</h5>
                <h2 class="text-3xl font-bold mt-1">{{ stats.total_entries }}</h2>
            </div>
            <div class="stats-card text-white">
                <h5 class="text-sm font-medium opacity-80">Rata-rata Confidence</h5>
                <h2 class="text-3xl font-bold mt-1">{{ "%.2f"|format(stats.avg_confidence * 100) }}%</h2>
            </div>
            <div class="stats-card text-white">
                <h5 class="text-sm font-medium opacity-80">Rata-rata Likes</h5>
                <h2 class="text-3xl font-bold mt-1">{{ "%.1f"|format(stats.avg_likes) }}</h2>
            </div>
            <div class="stats-card text-white">
                <h5 class="text-sm font-medium opacity-80">Distribusi Sentimen</h5>
                {% for sentiment, count in stats.sentiment_counts.items() %}
                <div class="flex justify-between items-center mt-2">
                    <span class="opacity-80">{{ sentiment }}</span>
                    <span class="font-medium">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="dashboard-card">
                <div class="p-6">
                    <h5 class="text-lg font-medium text-gray-900 mb-4">Analisis Sentimen Text</h5>
                    <form id="analysisForm">
                        <textarea 
                            class="custom-textarea mb-4" 
                            name="comment" 
                            rows="3" 
                            placeholder="Masukkan text untuk dianalisis..."
                        ></textarea>
                        <button type="submit" class="custom-button">Analisis</button>
                    </form>
                    <div id="analysisResult" class="hidden mt-4">
                        <h6 class="text-sm font-medium text-gray-700 mb-2">Hasil:</h6>
                        <div id="sentimentResult"></div>
                    </div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="p-6">
                    <h5 class="text-lg font-medium text-gray-900 mb-4">Model Training</h5>
                    <button id="trainButton" class="custom-button">Latih Model dengan Dataset</button>
                    <div id="trainResult" class="hidden mt-4">
                        <div class="bg-green-50 text-green-800 rounded-lg p-4">
                            Model berhasil dilatih!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if plots %}
        <div class="dashboard-card mb-8">
            <div class="p-6">
                <h5 class="text-lg font-medium text-gray-900 mb-4">Visualisasi Data</h5>
                <div id="plotlyCharts" style="width:100%; height:800px;"></div>
            </div>
        </div>
        {% endif %}

        {% if data %}
        <div class="dashboard-card">
            <div class="p-6">
                <h5 class="text-lg font-medium text-gray-900 mb-4">Dataset Berlabel</h5>
                <div class="custom-table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Text</th>
                                <th>Preprocessed</th>
                                <th>Sentiment</th>
                                <th>Confidence</th>
                                <th>Likes</th>
                                <th>Created At</th>
                                <th>Username</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for row in data %}
                            <tr>
                                <td><div class="text-cell">{{ row.text }}</div></td>
                                <td><div class="text-cell">{{ row.preprocessed_text }}</div></td>
                                <td><span class="sentiment-badge {{ row.sentiment }}">{{ row.sentiment }}</span></td>
                                <td>{{ "%.1f"|format(row.confidence * 100) }}%</td>
                                <td>{{ row.favorite_count }}</td>
                                <td>{{ row.created_at }}</td>
                                <td>{{ row.username }}</td>
                                <td>{{ row.source_dataset }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const plotlyDataElement = document.getElementById('plotly-data');
            if (plotlyDataElement) {
                try {
                    const plotsData = JSON.parse(plotlyDataElement.textContent);
                    Plotly.newPlot('plotlyCharts', plotsData.data, plotsData.layout)
                        .catch(error => console.error('Error plotting:', error));
                } catch (error) {
                    console.error('Error parsing plot data:', error);
                }
            }
        });

        $('#analysisForm').on('submit', function(e) {
            e.preventDefault();
            const text = $('textarea[name="comment"]').val();
            
            $.ajax({
                url: '/api/analyze',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ comment: text }),
                success: function(response) {
                    $('#analysisResult').removeClass('hidden').addClass('block');
                    $('#sentimentResult').html(`
                        <div class="space-y-2">
                            <span class="sentiment-badge ${response.sentiment}">
                                ${response.sentiment.toUpperCase()}
                            </span>
                            <div class="text-sm text-gray-600">
                                Confidence: ${Math.round(response.confidence * 100)}%
                            </div>
                            <div class="text-sm text-gray-600">
                                Preprocessed: ${response.text}
                            </div>
                        </div>
                    `);
                }
            });
        });

        $('#trainButton').click(function() {
            $(this).prop('disabled', true).text('Melatih...');
            
            $.get('/api/analyze-data', function(response) {
                if (response.success) {
                    $('#trainResult').removeClass('hidden').addClass('block');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .fail(function() {
                alert('Terjadi kesalahan saat melatih model');
            })
            .always(function() {
                $('#trainButton').prop('disabled', false).text('Latih Model dengan Dataset');
            });
        });
    </script>
</body>
</html>